<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勉強記録・復習 | テス勉お助け！</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': '#4CAF50',
                        'secondary': '#8BC34A',
                        'accent': '#FFC107',
                        'danger': '#F44336',
                        'background': '#f4f4f4',
                    }
                }
            }
        }
    </script>
    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body class="bg-background min-h-screen dark:bg-gray-900 transition-colors duration-300">
    <!-- 共通ヘッダーのインクルード -->
    {% include '_header.html' %}

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- ページヘッダー -->
        <div class="mb-8">
            <h2 class="text-3xl font-extrabold text-gray-800 dark:text-white mb-3 flex items-center">
                <i class="ph-bold ph-books text-3xl mr-3 text-primary"></i>
                学習記録と復習管理
            </h2>
            <p class="text-gray-600 dark:text-gray-400">過去の学習記録を確認し、効率的な復習を進めましょう</p>
        </div>

        <!-- 復習が必要なポイントセクション -->
        <section class="mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-danger">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-danger flex items-center">
                        <i class="ph-bold ph-warning-circle text-2xl mr-2"></i>
                        未復習ポイント
                    </h3>
                    <span class="bg-danger text-white px-3 py-1 rounded-full text-sm font-bold">
                        {{ unmastered_points|length }}件
                    </span>
                </div>

                {% if unmastered_points %}
                    <div class="space-y-3">
                        {% for point in unmastered_points %}
                            <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4 hover:shadow-md transition duration-200">
                                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center mb-2">
                                            <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded mr-2">
                                                {{ point.subject }}
                                            </span>
                                            <span class="text-xs text-gray-500 dark:text-gray-400">{{ point.study_date }}</span>
                                        </div>
                                        <p class="text-gray-800 dark:text-white font-medium mb-1">{{ point.content }}</p>
                                        <p class="text-red-600 dark:text-red-400 text-sm flex items-center">
                                            <i class="ph-bold ph-question mr-1"></i>復習が必要なポイント
                                        </p>
                                    </div>
                                    <form action="{{ url_for('toggle_mastery', record_id=point.id) }}" method="GET">
                                        <input type="hidden" name="mastered_id" value="{{ point.id }}">
                                        <button type="submit" 
                                                class="w-full sm:w-auto bg-primary hover:bg-secondary text-white font-medium py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 text-sm">
                                            <i class="ph-bold ph-check-circle mr-1"></i>復習完了
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-6">
                        <i class="ph-bold ph-smiley text-4xl text-green-500 mb-3"></i>
                        <p class="text-gray-600 dark:text-gray-400 font-medium">素晴らしい！未復習のポイントはありません</p>
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- フィルターと全記録セクション -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- フィルターサイドバー -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 sticky top-24">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4 flex items-center">
                        <i class="ph-bold ph-funnel text-xl mr-2 text-primary"></i>
                        絞り込み
                    </h3>
                    
                    <!-- カレンダーフィルター追加 -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-3 flex items-center">
                            <i class="ph-bold ph-calendar-blank mr-2 text-primary"></i>
                            日付で選択
                        </h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-3">
                            <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                                {% set weekdays = ['日', '月', '火', '水', '木', '金', '土'] %}
                                {% for day in weekdays %}
                                    <div class="font-medium text-gray-500 dark:text-gray-400">{{ day }}</div>
                                {% endfor %}
                            </div>
                            <div class="grid grid-cols-7 gap-1" id="recordsCalendar">
                                <!-- カレンダー日付はJavaScriptで動的に生成 -->
                            </div>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <button id="selectToday" class="flex-1 bg-primary hover:bg-secondary text-white text-sm py-2 rounded transition duration-200">
                                今日
                            </button>
                            <button id="clearDate" class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 text-sm py-2 rounded transition duration-200">
                                クリア
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="records_subject_filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">科目</label>
                            <select id="records_subject_filter" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="all">全ての科目</option>
                                {% for subject in custom_subjects %}
                                <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="records_start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">開始日</label>
                            <input type="date" id="records_start_date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <div>
                            <label for="records_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">終了日</label>
                            <input type="date" id="records_end_date" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        
                        <button id="apply_filter_btn" class="w-full bg-primary hover:bg-secondary text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            <i class="ph-bold ph-magnifying-glass mr-2"></i>適用
                        </button>
                    </div>
                </div>
            </div>

            <!-- 全記録の表示セクション -->
            <div class="lg:col-span-3">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                            <i class="ph-bold ph-scroll text-2xl mr-2 text-primary"></i>
                            全ての学習記録
                        </h3>
                        <span class="bg-primary text-white px-3 py-1 rounded-full text-sm font-bold">
                            {{ records|length }}件
                        </span>
                    </div>

                    <div id="records_container" class="space-y-4">
                        {% for record in records %}
                            <div class="record-card border border-gray-200 dark:border-gray-700 rounded-lg hover:shadow-md transition duration-200
                                        {% if record.is_mastered %}bg-green-50 dark:bg-green-900 border-green-200 dark:border-green-700{% else %}bg-white dark:bg-gray-800{% endif %}"
                                 data-subject="{{ record.subject }}"
                                 data-date="{{ record.study_date }}">
                                
                                <div class="p-4">
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3">
                                        <div>
                                            <div class="flex items-center mb-2">
                                                <span class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded mr-2">
                                                    {{ record.subject }}
                                                </span>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">{{ record.study_date }}</span>
                                            </div>
                                            <h4 class="text-lg font-bold text-gray-800 dark:text-white">{{ record.content }}</h4>
                                        </div>
                                        <div class="flex items-center space-x-2 mt-2 sm:mt-0">
                                            <span class="px-3 py-1 text-xs font-bold rounded-full 
                                                        {% if record.is_mastered %}bg-primary text-white{% else %}bg-danger text-white{% endif %}">
                                                {% if record.is_mastered %}復習済{% else %}未復習{% endif %}
                                            </span>
                                            
                                            <!-- アクションボタングループ -->
                                            <div class="flex space-x-1">
                                                <!-- 共有ボタン -->
                                                <a href="{{ url_for('share_single', record_id=record.id) }}" 
                                                   class="text-blue-500 hover:text-blue-700 transition duration-200 p-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900"
                                                   title="共有">
                                                    <i class="ph-bold ph-share-network text-lg"></i>
                                                </a>
                                                
                                                <!-- 削除ボタン -->
                                                <form action="{{ url_for('delete_record', record_id=record.id) }}" method="GET">
                                                    <input type="hidden" name="record_id" value="{{ record.id }}">
                                                    <button type="submit" 
                                                            class="text-red-500 hover:text-red-700 transition duration-200 p-1 rounded hover:bg-red-100 dark:hover:bg-red-900"
                                                            onclick="return confirm('この学習記録を削除してもよろしいですか？')"
                                                            title="削除">
                                                        <i class="ph-bold ph-trash text-lg"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-gray-600 dark:text-gray-400 mt-4">
                                        <div class="flex items-center">
                                            <i class="ph-bold ph-clock text-gray-400 mr-2"></i>
                                            学習時間: {{ record.learning_time }}分
                                        </div>
                                        <div class="flex items-center">
                                            <i class="ph-bold ph-gauge text-gray-400 mr-2"></i>
                                            難易度: {{ record.difficulty }}/5
                                        </div>
                                        <div class="flex items-center">
                                            <i class="ph-bold ph-calendar text-gray-400 mr-2"></i>
                                            記録日: {{ record.timestamp }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                <i class="ph-bold ph-note-pencil text-5xl text-gray-300 mb-4"></i>
                                <p class="text-lg text-gray-500 dark:text-gray-400 mb-2">まだ学習記録がありません</p>
                                <a href="{{ url_for('dashboard') }}" class="inline-block bg-primary text-white py-2 px-6 rounded-lg hover:bg-secondary transition duration-300">
                                    最初の記録を始める
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript for Filtering -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recordsSubjectFilter = document.getElementById('records_subject_filter');
            const recordsStartDateInput = document.getElementById('records_start_date');
            const recordsEndDateInput = document.getElementById('records_end_date');
            const applyFilterBtn = document.getElementById('apply_filter_btn');
            const recordsContainer = document.getElementById('records_container');
            
            // カレンダー関連の変数
            const recordsCalendar = document.getElementById('recordsCalendar');
            const selectTodayBtn = document.getElementById('selectToday');
            const clearDateBtn = document.getElementById('clearDate');
            
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let selectedDate = null;
            
            // カレンダー生成関数
            function generateCalendar(month, year) {
                recordsCalendar.innerHTML = '';
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startingDay = firstDay.getDay();
                const monthLength = lastDay.getDate();
                
                // 前月の日付（空セル）
                for (let i = 0; i < startingDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'h-8';
                    recordsCalendar.appendChild(emptyDay);
                }
                
                // 今月の日付
                const allRecordCards = recordsContainer.querySelectorAll('.record-card');
                const recordDates = Array.from(allRecordCards).map(card => card.getAttribute('data-date'));
                
                for (let day = 1; day <= monthLength; day++) {
                    const dayElement = document.createElement('button');
                    const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    dayElement.className = 'h-8 w-8 rounded text-sm transition duration-200 hover:bg-gray-200 dark:hover:bg-gray-600';
                    dayElement.textContent = day;
                    dayElement.setAttribute('data-date', fullDate);
                    
                    // 学習記録がある日をハイライト
                    const hasRecord = recordDates.includes(fullDate);
                    
                    if (hasRecord) {
                        dayElement.classList.add('bg-primary', 'text-white', 'font-bold');
                    } else {
                        dayElement.classList.add('text-gray-700', 'dark:text-gray-300');
                    }
                    
                    // 選択された日付
                    if (selectedDate === fullDate) {
                        dayElement.classList.remove('bg-primary', 'text-white');
                        dayElement.classList.add('bg-secondary', 'text-white');
                    }
                    
                    dayElement.addEventListener('click', function() {
                        selectedDate = fullDate;
                        updateDateInputs(fullDate, fullDate);
                        applyFilter();
                        generateCalendar(currentMonth, currentYear); // カレンダー再描画
                    });
                    
                    recordsCalendar.appendChild(dayElement);
                }
            }
            
            // 日付入力フィールド更新関数
            function updateDateInputs(startDate, endDate) {
                recordsStartDateInput.value = startDate;
                recordsEndDateInput.value = endDate;
            }
            
            // 今日を選択
            selectTodayBtn.addEventListener('click', function() {
                const today = new Date().toISOString().split('T')[0];
                selectedDate = today;
                updateDateInputs(today, today);
                applyFilter();
                generateCalendar(currentMonth, currentYear);
            });
            
            // 日付選択をクリア
            clearDateBtn.addEventListener('click', function() {
                selectedDate = null;
                recordsStartDateInput.value = '';
                recordsEndDateInput.value = '';
                applyFilter();
                generateCalendar(currentMonth, currentYear);
            });
            
            // フィルター適用関数
            const applyFilter = () => {
                const selectedSubject = recordsSubjectFilter.value;
                const startDate = recordsStartDateInput.value ? new Date(recordsStartDateInput.value) : null;
                
                let endDate = null;
                if (recordsEndDateInput.value) {
                    endDate = new Date(recordsEndDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                }

                const allRecordCards = recordsContainer.querySelectorAll('.record-card');

                allRecordCards.forEach(card => {
                    const cardSubject = card.getAttribute('data-subject');
                    const cardDate = new Date(card.getAttribute('data-date'));
                    
                    let isSubjectMatch = (selectedSubject === 'all' || cardSubject === selectedSubject);
                    let isDateMatch = true;
                    
                    if (startDate && endDate) {
                        isDateMatch = cardDate >= startDate && cardDate <= endDate;
                    } else if (startDate) {
                        isDateMatch = cardDate >= startDate;
                    } else if (endDate) {
                        isDateMatch = cardDate <= endDate;
                    }
                    
                    if (isSubjectMatch && isDateMatch) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };

            applyFilterBtn.addEventListener('click', applyFilter);
            recordsSubjectFilter.addEventListener('change', applyFilter);
            recordsStartDateInput.addEventListener('change', function() {
                selectedDate = null; // 日付入力フィールドを直接変更した場合はカレンダー選択を解除
                applyFilter();
            });
            recordsEndDateInput.addEventListener('change', function() {
                selectedDate = null; // 日付入力フィールドを直接変更した場合はカレンダー選択を解除
                applyFilter();
            });

            // 初期カレンダー生成
            generateCalendar(currentMonth, currentYear);
        });
    </script>

    <!-- ダークモード設定の読み込み -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            const html = document.documentElement;
            
            if (isDarkMode) {
                html.classList.add('dark');
            }
        });
    </script>
</body>
</html>